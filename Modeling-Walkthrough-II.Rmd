---
title: "Modeling Walkthrough II - Predicting the Proportion of Votes "
output: 
  html_document:
    theme: yeti
---
## Introduction

In this notebook, we are going to predict the proportion of votes attained by each party in each constituency. We will be incorporating a few more features into our model fit and using some data that has been preprocessed and can be found in the data folder of the Github repository. This type of prediction requires regression and as such we are going to use a Linear Regressor.

First, we load a couple of packages.  We are going to use `dplyr` to manipulate our data, `GGally` to visualise our data and then fit a `caret` model to come up with some predictions. We will also be using `magrittr`'s pipe for readability.


```{r setup, message = FALSE, warning = FALSE, results = 'hide'}
library(dplyr)
library(caret)
library(GGally)
library(magrittr)
```


## Importing and Exploring

We import our model ready data and have a look at what we are dealing with.

```{r import_data, cache = TRUE}
df <- read.csv("data/ge_2010_2015_training_data.csv")
head(df[1:3], n = 15L)
colnames(df)
```

Notable additions to the data:

* Polling data: We have `polls_now` which gives us the proportional polling data
* Swing data: We have `swing_now` which gives us the change in proportion of votes between the last election and the polls preceeding the current election, `swing_forecast_pc` gives us the forecasted change in proportion of votes from now to the election
* `won_here_last` gives us whether or not the same party won the last election
* `actual_pc_now` gives us our target variable; the proportion of votes attained in the election in this constituency by this party.

Now, we are going to use `ggplot2` to visualise the relationships between some of our features. Using this, we can see how useful they are going to be to our model.

``` {r pairplot, cache = TRUE, message = FALSE, warning = FALSE}
feature_cols <- df[c(4:7, 12, 15)]
k <- ggpairs(feature_cols, aes(colour = party), upper = list(continuous = wrap("cor", size = 1, hjust=0.15, alignPercent=1)))
k
```

## Swing or no Swing?

Now we are going to use evaluate the use of swing in our model by seeing how effective it is in predicting the number of seats won by each party nationally. We do this by comparing `swing_forecast_win` with the actual results of the 2015 election.

```{r swing, cache = TRUE}
# Seats won in 2010
df_unique <- df[!duplicated(df$Constituency.Name), ]
seats_10 <- df_unique[c(2,9)] %>% group_by(win_last) %>% count()
seats_10

# Seats forecast to win in 2015 using Swing
swing_10 <- df_unique[c(2, 13)] %>% group_by(swing_forecast_win) %>% count()
swing_10

seats_15 <- df_unique[c(2, 14)] %>% group_by(actual_win_now) %>% count()
seats_15
```

Next, we calculate the difference in proportion of votes actually attained and the proportion stated in `swing_forecast_pc`.

``` {r seat_error, cache = TRUE}
# Total average error per party per seat
df2 <- df[c(2, 12, 15)] %>% mutate(error = swing_forecast_pc - actual_pc_now)

mean(df2$error)

```

This tells us that *swing* is going to be very useful in predicting the proportion of votes and so we will use it as a feature.

## Fitting our Model

In this section we are going to fit our model and calculate how accurate our model fit is by using Cross Validation.

We apply K Fold Cross Validation which means that we take our data set and do the following:

* Split it into K parts
* Train our model on K-1 of those parts
* Test our model on the last part
* Calculate the accuracy on the last part

We repeat these steps a few times and average our error.

``` {r cross_validation, cache = TRUE, warning = FALSE, message = FALSE}
train_control <- trainControl(method="repeatedcv", number=5, repeats=5)

party_model <- train(actual_pc_now ~ . , data = df[c(4:12, 15)], trControl = train_control, method = "lm" )

# We choose to look at the Mean Absolute Error
print(party_model$results$MAE)
```

Wow! we get a mean absolute error of around 3%. That's awesome.

So what's next..?

## Extensions

- You can fork this Rmarkdown document and pick up where we left off by trying out some new models, or improve this one.

- Or you could choose something else to predict, like maybe using the model_2015 data set to predict how people voted in the EU referendum.

The possibilities are endless!